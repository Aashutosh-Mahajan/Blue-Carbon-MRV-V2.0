{% extends 'api/base.html' %}
{% load form_extras %}
{% block content %}
<div class="max-w-3xl mx-auto card-bg backdrop-blur-sm rounded-2xl shadow-lg border p-8 animate-slideUp register-form">
  <h1 class="text-2xl font-bold mb-6 text-slate-800">Corporate Registration</h1>
  <form method="post" class="space-y-5" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.username }}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Basic Details -->
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Company Name</label>
        {{ form.company_name|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.company_name.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Corporate Email (use company domain)</label>
        {{ form.email|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.email.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <!-- Business Verification -->
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">CIN (Corporate Identification Number)</label>
        {{ form.cin|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.cin.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">GSTIN</label>
        {{ form.gst_number|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.gst_number.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">PAN of the Company</label>
        {{ form.company_pan|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.company_pan.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Password</label>
        <div class="relative">
          {{ form.password|add_class:"w-full pl-3 pr-10 py-3 bg-white border border-slate-300 rounded-lg|id=corp_password" }}
          <button type="button" id="toggle-corp-password" class="absolute inset-y-0 right-2 my-auto text-slate-500 hover:text-slate-700">üëÅÔ∏è</button>
        </div>
        {% for e in form.password.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Confirm Password</label>
        <div class="relative">
          {{ form.confirm_password|add_class:"w-full pl-3 pr-10 py-3 bg-white border border-slate-300 rounded-lg|id=corp_confirm_password" }}
          <button type="button" id="toggle-corp-confirm" class="absolute inset-y-0 right-2 my-auto text-slate-500 hover:text-slate-700">üëÅÔ∏è</button>
        </div>
        <p id="corp-password-match" class="text-xs mt-1"></p>
        {% for e in form.confirm_password.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">GST Document</label>
        {{ form.gst_document|add_class:"w-full bg-white" }}
        {% for e in form.gst_document.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Certificate of Incorporation</label>
          {{ form.certificate_of_incorporation|add_class:"w-full bg-white" }}
          {% for e in form.certificate_of_incorporation.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
        </div>
        <div>
          <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Board Resolution / Authorized Signatory Letter</label>
          {{ form.board_resolution|add_class:"w-full bg-white" }}
          {% for e in form.board_resolution.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
        </div>
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">CSR Mandate (if applicable)</label>
          {{ form.csr_mandate|add_class:"w-full bg-white" }}
          {% for e in form.csr_mandate.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
        </div>
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Pincode</label>
        {{ form.pincode|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=pincode" }}
        {% for e in form.pincode.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Taluka / Block</label>
        {{ form.taluka|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=taluka" }}
        {% for e in form.taluka.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">District</label>
        {{ form.district|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=district" }}
        {% for e in form.district.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">State</label>
        {{ form.state|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=state" }}
        {% for e in form.state.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Contact Person Name</label>
        {{ form.contact_person_name|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.contact_person_name.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Phone (OTP)</label>
        <div class="flex gap-2">
          <div class="flex-1">{{ form.contact_number|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=corp_phone" }}</div>
          <button type="button" id="btn-send-corp-phone-otp" class="px-3 py-2 border rounded-lg text-blue-700 border-blue-300 hover:bg-blue-50">Send OTP</button>
        </div>
        <div class="mt-2 flex gap-2 items-center">
          <div class="flex-1">{{ form.phone_otp|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg|id=corp_phone_otp|placeholder=Enter Phone OTP" }}</div>
          <button type="button" id="btn-verify-corp-phone-otp" class="px-3 py-2 border rounded-lg text-green-700 border-green-300 hover:bg-green-50">Verify</button>
          <span id="corp-phone-otp-status" class="text-xs text-slate-600"></span>
        </div>
        {% for e in form.contact_number.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Wallet Address</label>
        {{ form.wallet_address|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.wallet_address.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
        {% if form.wallet_address.help_text %}<p class="text-[11px] text-slate-500 mt-1">{{ form.wallet_address.help_text }}</p>{% endif %}
      </div>
      
      <div class="md:col-span-2">
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-700 mb-2">Address</label>
        {{ form.address|add_class:"w-full pl-3 pr-3 py-3 bg-white border border-slate-300 rounded-lg" }}
        {% for e in form.address.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div class="md:col-span-2">
        <label class="inline-flex items-center space-x-3">
          {{ form.agreement }}
          <span class="text-sm text-slate-700">I confirm that the information provided is accurate and our Company is legally registered.</span>
        </label>
        {% for e in form.agreement.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>

      <div class="md:col-span-2">
        <label class="inline-flex items-center space-x-3">
          {{ form.accept_terms }}
          <span class="text-sm text-slate-700">I accept the <a href="/terms/" class="text-blue-600 underline">Terms & Conditions</a> &amp; <a href="/privacy/" class="text-blue-600 underline">Privacy Policy</a></span>
        </label>
        {% for e in form.accept_terms.errors %}<p class="text-red-700 text-xs mt-1">{{ e }}</p>{% endfor %}
      </div>
    </div>
    <button id="corp-submit-btn" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold py-3 rounded-xl shadow hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-emerald-500/30" disabled>Create Corporate Account</button>
  </form>
</div>
<script>
// Auto-fill taluka/district/state from India Postal pincode API (same as NGO form)
document.addEventListener('DOMContentLoaded', function(){
  const pincodeEl = document.getElementById('pincode');
  if(!pincodeEl) return;
  let timeout = null;
  pincodeEl.addEventListener('input', function(){
    clearTimeout(timeout);
    const val = this.value.trim();
    if(val.length < 6) return;
    timeout = setTimeout(() => {
      fetch(`https://api.postalpincode.in/pincode/${val}`)
        .then(r => r.json())
        .then(data => {
          if(Array.isArray(data) && data[0] && data[0].Status === 'Success'){
            const postOffice = data[0].PostOffice && data[0].PostOffice[0];
            if(postOffice){
              const tal = postOffice.Block || postOffice.Taluk || postOffice.Division || '';
              const dist = postOffice.District || '';
              const st = postOffice.State || '';
              const talEl = document.getElementById('taluka');
              const distEl = document.getElementById('district');
              const stEl = document.getElementById('state');
              if(talEl) talEl.value = tal;
              if(distEl) distEl.value = dist;
              if(stEl) stEl.value = st;
            }
          }
        })
        .catch(err => console.warn('Pincode lookup failed', err));
    }, 450);
  });
});

// Corporate Phone OTP handling (reuses existing backend endpoints)
document.addEventListener('DOMContentLoaded', function(){
  const phoneEl = document.getElementById('corp_phone');
  const phoneOtpEl = document.getElementById('corp_phone_otp');
  const sendBtn = document.getElementById('btn-send-corp-phone-otp');
  const verifyBtn = document.getElementById('btn-verify-corp-phone-otp');
  const statusEl = document.getElementById('corp-phone-otp-status');
  const submitBtn = document.getElementById('corp-submit-btn');
  let phoneVerified = false;
  // initialize shared password-match flag if not present
  if(typeof window.corpPasswordMatch === 'undefined') window.corpPasswordMatch = false;
  function updateSubmit(){ if(submitBtn) submitBtn.disabled = !phoneVerified || !window.corpPasswordMatch; }
  if(!sendBtn || !verifyBtn) return;
  sendBtn.addEventListener('click', async () => {
    const phone = (phoneEl?.value || '').trim();
    if(!phone){ statusEl.textContent='Enter phone first'; statusEl.className='text-xs text-red-600'; return; }
    statusEl.textContent='Sending...'; statusEl.className='text-xs text-slate-600';
    try{
      const r = await fetch('{% url "send_phone_otp" %}', {method:'POST', headers:{'X-CSRFToken': '{{ csrf_token }}'}, body: new URLSearchParams({phone})});
      const j = await r.json();
      if(j.ok){ statusEl.textContent='OTP sent to phone'; statusEl.className='text-xs text-green-700'; }
      else { statusEl.textContent=j.error||'Failed to send OTP'; statusEl.className='text-xs text-red-600'; }
    }catch(e){ statusEl.textContent='Network error'; statusEl.className='text-xs text-red-600'; }
  });
  verifyBtn.addEventListener('click', async () => {
    const phone = (phoneEl?.value || '').trim();
    const code = (phoneOtpEl?.value || '').trim();
    if(!code){ statusEl.textContent='Enter phone OTP'; statusEl.className='text-xs text-red-600'; return; }
    try{
      const r = await fetch('{% url "verify_phone_otp" %}', {method:'POST', headers:{'X-CSRFToken': '{{ csrf_token }}'}, body: new URLSearchParams({phone, code})});
      const j = await r.json();
      if(j.ok){ phoneVerified = true; statusEl.textContent='Phone verified'; statusEl.className='text-xs text-green-700'; updateSubmit(); }
      else { phoneVerified = false; statusEl.textContent=j.error||'Invalid code'; statusEl.className='text-xs text-red-600'; updateSubmit(); }
    }catch(e){ statusEl.textContent='Network error'; statusEl.className='text-xs text-red-600'; }
  });
});
</script>
<script>
// Show/hide password for Corporate
document.addEventListener('DOMContentLoaded', function(){
  const pwd = document.getElementById('corp_password');
  const cpwd = document.getElementById('corp_confirm_password');
  const tp = document.getElementById('toggle-corp-password');
  const tc = document.getElementById('toggle-corp-confirm');
  const pwdMsg = document.getElementById('corp-password-match');
  const submitBtn = document.getElementById('corp-submit-btn');
  // share password-match state across scripts
  window.corpPasswordMatch = false;
  function updateSubmit(){ if(submitBtn) submitBtn.disabled = !window.corpPasswordMatch; }
  function check(){
    const p = (pwd?.value || '');
    const c = (cpwd?.value || '');
    if(!c){ window.corpPasswordMatch = false; if(pwdMsg){ pwdMsg.textContent=''; pwdMsg.className='text-xs mt-1'; } return updateSubmit(); }
    if(p && c && p === c){ window.corpPasswordMatch = true; if(pwdMsg){ pwdMsg.textContent='Passwords match'; pwdMsg.className='text-xs text-green-700 mt-1'; } }
    else { window.corpPasswordMatch = false; if(pwdMsg){ pwdMsg.textContent='Passwords do not match'; pwdMsg.className='text-xs text-red-600 mt-1'; } }
    updateSubmit();
  }
  function toggle(el){ if(!el) return; el.type = (el.type === 'password') ? 'text' : 'password'; }
  tp?.addEventListener('click', ()=> toggle(pwd));
  tc?.addEventListener('click', ()=> toggle(cpwd));
  pwd?.addEventListener('input', check);
  cpwd?.addEventListener('input', check);
});
</script>
{% endblock %}
